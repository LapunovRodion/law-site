# Модуль расписания

Модуль расписания отвечает за:

- хранение информации о занятиях (парах) на протяжении семестра;
- полуавтоматическую генерацию расписания на основе учебной нагрузки;
- учёт разовых изменений (отмены, переносы, замены);
- предоставление удобного API для фронтенда (Next.js) для отображения расписания студентам и преподавателям.

Текущий стек:

- Backend: Strapi 5 (Node.js, TypeScript, PostgreSQL);
- Frontend: Next.js (TypeScript), Strapi используется как headless CMS.

---

## 1. Модель данных

Все сущности создаются как Collection Types в Strapi.

### 1.1. Semester

Семестр — временной промежуток, в рамках которого строится расписание.

Поля:

- `name` — человекочитаемое имя (например, "Осень 2025");
- `slug` — uid (например, "fall-2025");
- `startDate` — дата начала семестра (понедельник первой учебной недели);
- `endDate` — дата окончания семестра;
- `weekCount` — количество недель (опционально, можно вычислять по датам).

Использование:

- привязка учебной нагрузки (`CourseLoad`) и занятий (`Lesson`);
- вычисление номера недели и её чётности.

---

### 1.2. StudyGroup

Учебная группа.

Поля:

- `name` — отображаемое имя (например, "Юр-21");
- `slug` — uid (например, "jur-21");
- `course` — курс (1–4, магистратура и т.п.);
- `faculty` — факультет (строка или enum, опционально).

Использование:

- основной фильтр для расписания по группе;
- связь с `CourseLoad`, `Lesson`, `LessonOverride`.

---

### 1.3. Teacher

Преподаватель.

Поля:

- `fullName` — ФИО полностью;
- `shortName` — краткая форма для расписания (например, "Иванов И.И.");
- `slug` — uid.

Использование:

- связь с `CourseLoad`, `Lesson`, `LessonOverride`;
- фильтрация расписания по преподавателю.

---

### 1.4. Room

Аудитория.

Поля:

- `building` — корпус;
- `number` — номер помещения;
- `type` — тип аудитории (например, `lecture`, `seminar`, `computer`, `other`).

Использование:

- связь с `Lesson`;
- подбор подходящей аудитории при генерации расписания.

---

### 1.5. Subject

Дисциплина.

Поля:

- `name` — полное название (например, "Гражданское право");
- `shortName` — сокращение (например, "ГП");
- `type` — тип занятия: `lecture` / `seminar` / `practice`.

Использование:

- связь с `CourseLoad`, `Lesson`, `LessonOverride`;
- отображение предмета в расписании.

---

### 1.6. Timeslot

Временной слот — конкретный номер пары в конкретный день недели.

Поля:

- `dayOfWeek` — число 1–7 (1 — понедельник, 7 — воскресенье; обычно используются 1–6);
- `pairNumber` — номер пары (1, 2, 3, …);
- `startTime` — время начала (например, "08:00");
- `endTime` — время окончания (например, "09:35").

Использование:

- связь с `Lesson` и `LessonOverride`;
- основа для сетки расписания.

---

### 1.7. CourseLoad

Учебная нагрузка: "что должно быть в расписании", без привязки к конкретным дням.

Поля:

- `semester` — ссылка на `Semester`;
- `group` — ссылка на `StudyGroup`;
- `subject` — ссылка на `Subject`;
- `teacher` — ссылка на `Teacher`;
- `lessonsPerWeek` — количество пар в неделю по этой дисциплине;
- `weekType` — режим:
  - `all` — каждую неделю;
  - `odd` — только нечётные недели;
  - `even` — только чётные недели;
  - `custom` — кастомный диапазон недель;
- `roomType` — желаемый тип аудитории (одно из значений `Room.type`);
- `notes` — комментарий (подгруппы, онлайн-формат и т.п.).

Использование:

- исходные данные для генератора расписания;
- опциональная связь с созданными `Lesson`.

---

### 1.8. Lesson

Конкретное занятие в базовой сетке расписания на весь семестр.

Поля:

- `semester` — `Semester`;
- `group` — `StudyGroup`;
- `subject` — `Subject`;
- `teacher` — `Teacher`;
- `room` — `Room`;
- `timeslot` — `Timeslot`;
- `weekType` — `all` / `odd` / `even` / `custom`;
- `startWeek` — номер первой недели, с которой пара идёт (опционально);
- `endWeek` — номер последней недели (опционально);
- `note` — произвольный комментарий;
- `courseLoad` — ссылка на `CourseLoad` (опционально).

Интерпретация:

- `all` — пара идёт каждую неделю семестра или в диапазоне `startWeek…endWeek`;
- `odd` — только на нечётных неделях;
- `even` — только на чётных;
- `custom` — пара идёт в диапазоне `startWeek…endWeek` (в первой версии — один непрерывный отрезок).

---

### 1.9. LessonOverride

Разовые изменения расписания (отмена, перенос, замена).

Поля:

- `lesson` — ссылка на `Lesson` (опционально; если привязка к существующей записи);
- `group` — ссылка на `StudyGroup` (если `lesson` не указан);
- `date` — конкретная календарная дата;
- `action` — тип изменения:
  - `cancel` — отмена;
  - `move` — перенос;
  - `replace` — замена;
- `newSubject` — `Subject` (для `replace`);
- `newTeacher` — `Teacher` (для `replace`);
- `newRoom` — `Room` (для `move` / `replace`);
- `newTimeslot` — `Timeslot` (для `move` / `replace`);
- `comment` — комментарий.

Логика:

- `cancel` — базовая пара в указанную дату не показывается;
- `move` — пара показывается в другом слоте и/или аудитории;
- `replace` — пара остаётся в том же слоте, но меняется предмет/преподаватель/аудитория.

---

## 2. Логика недель и чётности

Номер учебной недели внутри семестра вычисляется по дате:

weekNumber = floor( (date - semester.startDate) / 7 дней ) + 1

Где:

- `semester.startDate` — дата начала семестра (обычно понедельник первой учебной недели);
- `date` — календарная дата, для которой считаем неделю;
- `weekNumber` — номер недели (1, 2, 3, …).

Чётность недели:

- если `weekNumber % 2 === 1` → неделя нечётная (`odd`);
- если `weekNumber % 2 === 0` → неделя чётная (`even`).

Использование:

- при выборке `Lesson` для конкретной недели:
  - учитывать `weekType` (`all`, `odd`, `even`, `custom`);
  - при `custom` дополнительно смотреть `startWeek` / `endWeek`;
- при формировании ответа API для фронтенда полезно возвращать:
  - `weekNumber`;
  - `weekParity` (`odd` / `even`).

---

## 3. Роли и сценарии

### 3.1. Роли

**Админ / ответственный за расписание (деканат / кафедра)**

- создаёт семестры (`Semester`);
- ведёт справочники (`StudyGroup`, `Teacher`, `Room`, `Subject`, `Timeslot`);
- заводит учебную нагрузку (`CourseLoad`);
- запускает генерацию расписания (создание `Lesson`);
- вручную корректирует `Lesson`;
- создаёт разовые изменения (`LessonOverride`).

**Пользователь (студент / преподаватель)**

- через сайт смотрит расписание:
  - по группе (неделя / день);
  - по преподавателю (опционально в будущем);
  - с учётом отмен, переносов и замен.

---

## 4. Жизненный цикл семестра

### 4.1. Подготовка семестра

1. Создать `Semester` в админке Strapi:
   - заполнить `name`, `slug`;
   - указать `startDate`, `endDate`;
   - при необходимости задать `weekCount`.

2. Проверить и, при необходимости, заполнить справочники:
   - `StudyGroup` — все учебные группы;
   - `Teacher` — все преподаватели;
   - `Room` — доступные аудитории с типами;
   - `Subject` — список дисциплин;
   - `Timeslot` — все пары по дням недели (например, Пн–Сб, пары 1–5).

3. Завести учебную нагрузку (`CourseLoad`):

   - для каждой комбинации «группа + предмет + преподаватель» создать запись `CourseLoad`;
   - указать:
     - `semester`;
     - `group`, `subject`, `teacher`;
     - `lessonsPerWeek`;
     - `weekType` (`all`, `odd`, `even`, `custom`);
     - при необходимости `roomType` и `notes`.

---

### 4.2. Генерация базового расписания (Lesson)

Цель: автоматически разложить `CourseLoad` по сетке `Timeslot` + `Room` и получить список `Lesson`.

1. Админ вызывает генерацию (например, эндпоинт `POST /schedule/generate` с `semesterId`).
2. Backend:
   - загружает `CourseLoad` для указанного семестра;
   - загружает все `Timeslot`;
   - загружает все `Room`;
   - загружает уже существующие `Lesson` для этого семестра (учёт занятости и повторной генерации).
3. Из `CourseLoad` формируется список задач:
   - если `lessonsPerWeek = 3`, создаются 3 задачи для одной комбинации (group + subject + teacher);
   - задача = «надо поставить одну пару» с заданными `group`, `subject`, `teacher`, `weekType`, `roomType`, `courseLoadId`.
4. Строятся карты занятости:
   - `groupId + timeslotId` → занято / свободно;
   - `teacherId + timeslotId` → занято / свободно;
   - `roomId + timeslotId` → занято / свободно.
5. Применяется простой жадный алгоритм:
   - (опционально) задачи сортируются по «сложности» (например, сначала те, у кого меньше всего подходящих слотов/аудиторий);
   - для каждой задачи перебираются `Timeslot` и подходящие `Room`:
     - если группа, преподаватель и аудитория свободны в этом слоте → создаётся `Lesson`;
     - карты занятости обновляются.
6. Если задачу разместить не удалось:
   - она попадает в список `unassigned`;
   - информация о ней возвращается админу (для ручной расстановки либо пересмотра параметров).

Результат: таблица `Lesson` содержит базовую сетку расписания на семестр.

---

### 4.3. Ручная доработка расписания

После автогенерации админ:

1. Открывает список `Lesson` в админке.
2. Фильтрует по:
   - `semester`;
   - `group` (и при необходимости `teacher`).
3. При необходимости вручную:
   - перемещает занятие на другой `Timeslot`;
   - меняет `Room`;
   - в крайних случаях — меняет `Teacher` / `Subject`;
   - добавляет или удаляет отдельные `Lesson`.

После этого `Lesson` считается базовой, "официальной" сеткой расписания без учёта разовых изменений.

---

### 4.4. Разовые изменения (LessonOverride)

Когда в течение семестра нужно:

- отменить пару;
- перенести пару (на другой день / время / аудиторию);
- заменить предмет или преподавателя,

базовую сетку `Lesson` не переписывают, а добавляют записи `LessonOverride`.

Сценарий для админа:

1. Найти нужную пару в `Lesson` (по группе / преподавателю / слоту) или задать связку `group + date + timeslot`.
2. Создать `LessonOverride`:
   - привязать к `lesson` или к `group` + `date` + `timeslot`;
   - указать `action`:
     - `cancel` — отменить;
     - `move` — перенести (нужны `newTimeslot` / `newRoom`);
     - `replace` — заменить (нужны `newSubject` / `newTeacher` / `newRoom` по необходимости);
   - при необходимости заполнить `comment`.
3. Сохранить override.

На уровне API:

- сначала берутся базовые `Lesson` для нужной недели;
- затем по конкретным датам к ним применяются `LessonOverride`;
- итог возвращается фронтенду уже с учётом всех изменений.

---

### 4.5. Просмотр расписания через фронтенд

Фронтенд (Next.js) получает данные через публичные эндпоинты, например:

- `GET /public-schedule/week?groupSlug=...&date=...` — расписание группы на неделю;
- (опционально позже) `GET /public-schedule/teacher-week?teacherSlug=...&date=...` — расписание преподавателя.

Общий сценарий backend для `public-schedule/week`:

1. По `groupSlug` найти `StudyGroup`.
2. По `date` определить:
   - к какому `Semester` относится дата;
   - `weekNumber` и `weekParity`.
3. Вычислить `weekStart` (понедельник недели) и `weekEnd` (воскресенье недели).
4. Загрузить `Lesson`:
   - только для нужного `semester`;
   - только для этой `group`;
   - подходящие по `weekType` и `startWeek` / `endWeek`.
5. Загрузить `LessonOverride`:
   - для этой `group` (и/или связанных `Lesson`);
   - с `date` в диапазоне от `weekStart` до `weekEnd`.
6. Применить overrides к базовым `Lesson`.
7. Сформировать ответ в виде структуры:

   - информация о группе и семестре;
   - `weekStart`, `weekNumber`, `weekParity`;
   - массив `days[]`, где:
     - `date`, `dayOfWeek`;
     - `lessons[]` — пары с полями:
       - `pairNumber`, `time`;
       - `subject`, `subjectShort`, `type`;
       - `teacher`, `room`;
       - `isOverride`, `overrideComment`.

Фронтенд:
- на десктопе — отображает таблицу (дни по столбцам, пары по строкам);
- на мобильном — список по дням с карточками пар.

---

## 5. Публичное API (таргетный дизайн)

Здесь фиксируется целевой контракт API. Детальная реализация — в отдельных задачах backend.

### 5.1. Генерация расписания

Служебный эндпоинт, только для админов.

Метод: POST  
Путь: `/schedule/generate`

Тело запроса (пример):

{
  "semesterId": 1
}

Пример ответа:

{
  "createdLessons": 42,
  "unassigned": [
    {
      "courseLoadId": 7,
      "reason": "Не найден свободный слот с аудиторией"
    }
  ]
}

---

### 5.2. Копирование семестра

Служебный эндпоинт, только для админов.

Метод: POST  
Путь: `/schedule/copy-semester`

Пример тела запроса:

{
  "fromSemesterId": 1,
  "toSemesterId": 2,
  "copyCourseLoad": true,
  "copyLessons": false,
  "overwrite": false
}

Поведение:

- копирование `CourseLoad` с изменением поля `semester`;
- опциональное копирование `Lesson` (черновик предыдущего семестра);
- если `overwrite = false`, не перезаписывать уже существующие данные.

---

### 5.3. Расписание по группе (публичный эндпоинт)

Метод: GET  
Путь: `/public-schedule/week?groupSlug=yur-21&date=2025-09-08`

Параметры:

- `groupSlug` — uid группы;
- `date` — дата внутри нужной учебной недели (если не передано — брать текущую дату).

Пример упрощённого ответа:

{
  "group": { "name": "Юр-21", "slug": "yur-21" },
  "semester": { "name": "Осень 2025", "slug": "fall-2025" },
  "weekStart": "2025-09-08",
  "weekNumber": 3,
  "weekParity": "odd",
  "days": [
    {
      "date": "2025-09-08",
      "dayOfWeek": 1,
      "lessons": [
        {
          "pairNumber": 1,
          "time": "08:00–09:35",
          "subject": "Гражданское право",
          "subjectShort": "ГП",
          "type": "lecture",
          "teacher": "Иванов И.И.",
          "room": "1-101",
          "isOverride": false,
          "overrideComment": null
        }
      ]
    }
  ]
}

Аналогичный эндпоинт можно реализовать для преподавателя: `/public-schedule/teacher-week`.

---

## 6. Ограничения и развитие

### 6.1. Текущие ограничения

- Генерация расписания основана на жадном алгоритме:
  - возможны "окна" у групп и преподавателей;
  - возможна неравномерная нагрузка по дням;
  - не учитываются "желательные" дни/время для преподавателей.
- `weekType = custom` в первой версии поддерживает только один непрерывный диапазон недель (`startWeek…endWeek`).
- Нет отдельной модели ограничений доступности преподавателей и аудиторий.

### 6.2. Возможные улучшения

- Добавить модели:
  - `TeacherAvailability` (когда преподаватель доступен);
  - `GroupConstraints` (максимум пар в день, запрет субботы и т.п.);
  - `RoomConstraints` (ограничения по видам занятий).
- Ввести "жёсткие" и "мягкие" ограничения и перейти от жадного алгоритма к более продвинутому решателю (с штрафами за окна, перегрузку и т.д.).
- Расширить API и UI:
  - расписание по преподавателю;
  - занятость аудитории;
  - экспорт расписания в PDF/Excel.
- Добавить аудит изменений (кто и когда изменил `Lesson` или `LessonOverride`).

---
